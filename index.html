<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Account OTP Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .account-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    label, input, button { display: block; margin-top: 10px; }
    pre { background: #f4f4f4; padding: 10px; }
    .copy-btn { cursor: pointer; margin-right: 10px; }
    .info-row { display: flex; align-items: center; margin-top: 10px; }
    .info-row button { margin-right: 10px; }
    .info-row span { flex-grow: 1; }
  </style>
</head>
<body>
  <h1>Account OTP Dashboard</h1>

  <label for="accountInput">Nhập thông tin tài khoản (username|password|email|passhotmail|refresh_token|client_id), mỗi tài khoản cách nhau bằng dấu xuống dòng:</label>
  <textarea id="accountInput" rows="5" placeholder="Nhập thông tin tài khoản"></textarea>

  <button onclick="saveAccounts()">Lưu tài khoản</button>

  <label for="accountSelect">Chọn số thứ tự tài khoản:</label>
  <select id="accountSelect" multiple></select>

  <button onclick="deleteSelectedAccounts()">Xóa tài khoản đã chọn</button>

  <div class="account-box" id="accountInfo" style="display:none">
    <strong>Thông tin tài khoản:</strong>
    <div class="info-row">
      <button class="copy-btn" onclick="copyToClipboard('user')">Copy</button>
      <span><b>User:</b> <span id="user"></span></span>
    </div>
    <div class="info-row">
      <button class="copy-btn" onclick="copyToClipboard('password')">Copy</button>
      <span><b>Password:</b> <span id="password"></span></span>
    </div>
    <div class="info-row">
      <button class="copy-btn" onclick="copyToClipboard('email')">Copy</button>
      <span><b>Email:</b> <span id="email"></span></span>
    </div>
    <div class="info-row">
      <button class="copy-btn" onclick="copyToClipboard('otp_result')">Copy</button>
      <span><b>OTP:</b> <span id="otp_result"></span></span>
    </div>
    <button onclick="getOtp()">Get OTP</button>
    <p><b>Thời gian lấy OTP lần cuối:</b> <span id="lastOtpTime"></span></p>
  </div>

  <script>
    // Fetch account information from GitHub
    async function fetchAccountsFromGitHub() {
      const fileUrl = 'https://raw.githubusercontent.com/manhmacnara/video-list/main/acc.txt';  // Raw URL to the acc.txt file

      try {
        const response = await fetch(fileUrl);
        const data = await response.text();  // Get the content of the file as text
        processAccounts(data);
      } catch (error) {
        console.error("Error fetching file from GitHub:", error);
      }
    }

    // Process and store account data from GitHub
    function processAccounts(accountData) {
      const accounts = accountData.split("\n");  // Split the data by new line to get each account
      const storedAccounts = accounts.map(account => {
        const fields = account.split("|");  // Split each account string by pipe '|'
        if (fields.length === 6) {  // Ensure there are 6 fields (user, password, email, passhotmail, refresh_token, client_id)
          const [user, password, email, pass_mail, refresh_token, client_id] = fields;
          return { user, password, email, pass_mail, refresh_token, client_id };
        }
        return null;
      }).filter(account => account !== null);

      localStorage.setItem('accounts', JSON.stringify(storedAccounts));
      loadAccounts();  // Update the account list after fetching the accounts
    }

    // Load accounts from localStorage and update the account select list
    function loadAccounts() {
      const accounts = JSON.parse(localStorage.getItem('accounts')) || [];
      const select = document.getElementById("accountSelect");
      select.innerHTML = '';  // Clear previous options

      accounts.forEach((acc, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = `Tài khoản #${index + 1} (Email: ${acc.email})`;
        select.appendChild(option);
      });

      if (accounts.length > 0) {
        select.value = 0;
        updateAccountInfo(0);
      }
    }

    // Save multiple accounts to localStorage
    function saveAccounts() {
      const accountString = document.getElementById('accountInput').value;
      const accountStrings = accountString.split("\n");

      const accounts = JSON.parse(localStorage.getItem('accounts')) || [];

      accountStrings.forEach(accountString => {
        const accountFields = accountString.split("|");

        if (accountFields.length === 6) {
          const [user, password, email, pass_mail, refresh_token, client_id] = accountFields;
          accounts.push({ user, password, email, pass_mail, refresh_token, client_id });
        }
      });

      localStorage.setItem('accounts', JSON.stringify(accounts));
      loadAccounts();
      document.getElementById('accountInput').value = '';
    }

    // Update account info when selected from the list
    function updateAccountInfo(index) {
      const accounts = JSON.parse(localStorage.getItem('accounts')) || [];
      const account = accounts[index];

      if (account) {
        document.getElementById("user").textContent = account.user;
        document.getElementById("password").textContent = account.password;
        document.getElementById("email").textContent = account.email;
        document.getElementById("accountInfo").style.display = "block";

        window.currentAccount = account;
        displayLastOtpTime(account.email);
      } else {
        document.getElementById("accountInfo").style.display = "none";
      }
    }

    // Delete selected accounts
    function deleteSelectedAccounts() {
      const select = document.getElementById("accountSelect");
      const selectedIndices = Array.from(select.selectedOptions).map(option => option.value);
      const accounts = JSON.parse(localStorage.getItem('accounts')) || [];

      selectedIndices.forEach(index => {
        accounts.splice(index, 1);
      });

      localStorage.setItem('accounts', JSON.stringify(accounts));
      loadAccounts();
      document.getElementById("accountInfo").style.display = "none";
    }

    // Display last OTP time for the selected account
    function displayLastOtpTime(email) {
      const lastOtpTime = localStorage.getItem(`lastOtpTime_${email}`);
      const timeElement = document.getElementById("lastOtpTime");

      if (lastOtpTime) {
        const timeDiff = getTimeDifference(new Date(lastOtpTime));
        timeElement.textContent = `Lần lấy OTP gần nhất: ${timeDiff}`;
      } else {
        timeElement.textContent = "Chưa có thông tin OTP.";
      }
    }

    // Calculate the time difference from the last OTP fetch
    function getTimeDifference(lastOtpDate) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - lastOtpDate) / 1000);
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      const diffInHours = Math.floor(diffInMinutes / 60);
      const diffInDays = Math.floor(diffInHours / 24);

      if (diffInDays > 0) {
        return `${diffInDays} ngày trước`;
      } else if (diffInHours > 0) {
        return `${diffInHours} giờ trước`;
      } else if (diffInMinutes > 0) {
        return `${diffInMinutes} phút trước`;
      } else {
        return `${diffInSeconds} giây trước`;
      }
    }

    // Fetch OTP
    async function getOtp() {
      const acc = window.currentAccount;

      const payload = {
        type: "tiktok",
        email: acc.email,
        refresh_token: acc.refresh_token,
        client_id: acc.client_id
      };

      try {
        const response = await fetch("https://tool.unlimitmail.com/api/get_code_oauth2", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        document.getElementById("otp_result").textContent = result.code || "Không nhận được OTP";
        localStorage.setItem(`lastOtpTime_${acc.email}`, new Date().toISOString());
        displayLastOtpTime(acc.email);
      } catch (err) {
        document.getElementById("otp_result").textContent = "Lỗi khi gọi API";
        console.error("Lỗi khi gọi API: ", err);
      }
    }

    // Initialize accounts when the page loads
    fetchAccountsFromGitHub();

    // Listen for account selection change
    document.getElementById("accountSelect").addEventListener("change", (event) => {
      updateAccountInfo(event.target.value);
    });

    // Copy to clipboard function
    function copyToClipboard(elementId) {
      const textToCopy = document.getElementById(elementId).textContent;
      const textarea = document.createElement("textarea");
      textarea.value = textToCopy;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      document.body.removeChild(textarea);
    }
  </script>
</body>
</html>
