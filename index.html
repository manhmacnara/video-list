<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account OTP Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    h2 {
      font-size: 1.5rem;
      margin: 0 0 15px;
      color: #333;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }
    .select-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    .select-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    select, input {
      font-size: 1rem;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    select[multiple] {
      height: auto;
      max-height: 60px;
      overflow-y: auto;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: flex-start;
      align-items: center;
      row-gap: 8px;
      margin-top: 5px;
      margin-bottom: 5px;
    }
    button {
      font-size: 0.9rem;
      padding: 8px 10px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .account-box {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-top: 15px;
    }
    .field { margin-bottom: 15px; }
    .label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #444;
    }
    .field-content {
      display: flex;
      align-items: stretch;
      gap: 5px;
      flex-wrap: nowrap;
      width: 100%;
      overflow-x: auto;
    }
    .field-content.no-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      width: 100%;
    }
    .scroll-box { overflow-x: auto; flex-grow: 1; }
    .scroll-box::-webkit-scrollbar { display: none; }
    .value {
      background: #eee;
      padding: 8px;
      border-radius: 5px;
      max-width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      word-break: keep-all;
      flex-grow: 1;
      min-width: 0;
      scrollbar-width: none;
    }
    .value::-webkit-scrollbar { display: none; }

    .copy-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      min-height: 42px;
    }
    .copy-btn:hover { background-color: #1e7e34; }

    .form-container { margin-top: 10px; display: none; }
    .form-container input,
    .form-container textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .form-container button { margin-top: 5px; }

    .action-buttons.bottom {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
    }
    .action-buttons.bottom .bottom { flex: 1; }

    button.secondary { background-color: #dc3545; }
    button.secondary:hover { background-color: #c82333; }
    button.nav-btn { background-color: #6c757d; }
    button.nav-btn:hover { background-color: #5a6268; }

    .provider-label { font-size: 0.8rem; color: #666; margin-left: 10px; }
    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 20px; height: 20px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    @media (min-height: 800px) {
      .search-bar { padding-bottom: 15px; }
      .checkbox-all { position: relative; z-index: 1000; }
    }

    @media (max-width: 480px) {
      .select-group { flex-direction: column; }
      .select-wrapper { width: 100%; }
      select, input { width: 100%; }
      .action-buttons { width: 100%; justify-content: space-between; }
      .field-content { display: flex; align-items: stretch; flex-wrap: nowrap; gap: 8px; width: 100%; overflow-x: auto; }
      .copy-btn { width: 50px; font-size: 0.7rem; padding: 4px 6px; }
      .action-buttons.bottom { flex-direction: row; flex-wrap: nowrap; gap: 5px; }
      .action-buttons.bottom .bottom { flex: 1; min-width: 0; }
      .select-wrapper > div { flex-direction: row; gap: 5px; }
    }

    .select-wrapper > div { display: flex; align-items: center; flex-wrap: nowrap; }
    .select-wrapper > div label { white-space: nowrap; }
    .field .label { display: none; }

    #accountCount { margin: 0; color: #222; font-size: 3rem; font-weight: bold; white-space: nowrap; }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    .action-button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 8px;
      margin-top: 15px;
    }
    .action-button-grid button { padding: 10px; font-size: 0.85rem; border: none; border-radius: 8px; color: white; cursor: pointer; white-space: nowrap; }
    .btn-blue { background-color: #007bff; color: white; border: none; cursor: pointer; }
    .btn-blue:hover { background-color: #0056b3; }
    .btn-red { background-color: #dc3545; }
    .btn-red:hover { background-color: #b52a30; }
    .btn-gray { background-color: #6c757d; }
    .btn-gray:hover { background-color: #555; }

    .search-bar { display: flex; align-items: center; gap: 8px; padding: 5px 0; overflow-x: auto; min-height: 40px; }
    .search-bar input[type="text"] { flex: 1; min-width: 100px; max-width: 160px; }
    .search-bar .checkbox-all { display: flex; align-items: center; font-size: 0.85rem; white-space: nowrap; flex-shrink: 0; min-width: 48px; }
    .search-bar button { padding: 6px 10px; font-size: 0.8rem; border-radius: 6px; border: none; background: #ddd; cursor: pointer; }
    .search-bar #accountCount { font-weight: bold; font-size: 0.85rem; white-space: nowrap; }

    @media (min-width: 600px) {
      .search-bar { flex-wrap: wrap; justify-content: space-between; padding: 10px 0; }
      .checkbox-all { min-width: 70px; font-size: 0.9rem; margin: 0 10px; }
      .search-bar input[type="text"] { max-width: 200px; flex: 1 1 200px; }
      .search-bar button { padding: 6px 10px; }
      #accountCount { white-space: nowrap; margin-left: auto; }
    }

    .checkbox-all { display: flex; align-items: center; white-space: nowrap; font-size: 0.85rem; margin: 0 5px; flex-shrink: 0; min-width: 50px; }
    .checkbox-all label { margin-left: 4px; display: inline-block; padding: 2px 5px; }

    .group-actions { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-start; flex-wrap: wrap; }
    .group-actions button { padding: 8px 10px; border-radius: 6px; cursor: pointer; }
    .group-actions .btn-red { background-color: #dc3545; }
    .group-actions .btn-red:hover { background-color: #b52a30; }
    .group-actions .btn-gray { background-color: #6c757d; }
    .group-actions .btn-gray:hover { background-color: #555; }
    .add-action-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-start; flex-wrap: wrap; }
    .add-action-buttons button { padding: 8px 10px; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="select-group">
      <div class="select-wrapper">
        <div style="flex items-center gap-2px mb-2">
          <label for="groupSelect" class="font-bold text-gray-700">üîñ Nh√≥m SD:</label>
          <select id="groupSelect" onchange="changeGroup()" class="flex-1">
            <option value="">Ch·ªçn nh√≥m</option>
          </select>
        </div>
      </div>
    </div>

    <div class="select-group">
      <div class="search-bar full-width">
        <input type="text" id="accountSearch" placeholder="T√¨m t√†i kho·∫£n..." oninput="filterAccounts()" style="flex: 1; max-width: 150px; min-width: 80px;" />
        <label for="searchAllGroups" class="checkbox-all">
          <input type="checkbox" id="searchAllGroups" onchange="filterAccounts()" style="margin-right: 4px;" />
          All
        </label>
        <button onclick="deselectAllAccounts()" style="padding: 5px 8px; font-size: 0.8rem;">Reset</button>
        <span id="accountCount" style="font-size: 0.8rem; white-space: nowrap;">#TK: 0</span>
      </div>
      <select id="accountSelect" onchange="changeAccount()" style="width: 100%; margin-top: 10px;"></select>
    </div>

    <div id="addGroupForm" class="form-container">
      <input type="text" id="newGroupName" placeholder="T√™n group..." />
      <button onclick="addGroup()">T·∫°o nh√≥m</button>
      <button onclick="toggleAddGroupForm()">H·ªßy</button>
    </div>

    <div id="addAccountForm" class="form-container">
      <input type="text" id="newUser" placeholder="User" />
      <input type="text" id="newPassword" placeholder="Password" />
      <input type="email" id="newEmail" placeholder="Email (Hotmail, Gmail, ho·∫∑c mail.tm)" />
      <input type="text" id="newPassMail" placeholder="Pass mail" />
      <input type="text" id="newRefreshToken" placeholder="Refresh Token (Hotmail/Gmail)" />
      <input type="text" id="newClientId" placeholder="Client ID (Hotmail/Gmail)" />
      <input type="text" id="newNote" placeholder="Ghi ch√∫ (tu·ª≥ ch·ªçn)" />
      <!-- NEW: 2FA Secret input -->
      <input type="text" id="new2FASecret" placeholder="2FA Secret (Base32, v√≠ d·ª• JBSWY3DPEHPK3PXP)" />
      <button onclick="addAccount()">Th√™m</button>
      <button onclick="toggleAddAccountForm()">H·ªßy</button>
    </div>

    <div id="addAccountLineForm" class="form-container">
      <textarea id="accountLine" placeholder="D√°n nhi·ªÅu d√≤ng (user|password|email|refresh_token|client_id|note|2fa_secret)" rows="3"></textarea>
      <button onclick="addAccountFromLine()">Th√™m</button>
      <button onclick="toggleAddAccountLineForm()">H·ªßy</button>
    </div>

    <div id="editAccountForm" class="form-container">
      <input type="text" id="editUser" placeholder="User" />
      <input type="text" id="editPassword" placeholder="Password" />
      <input type="email" id="editEmail" placeholder="Email" />
      <input type="text" id="editPassMail" placeholder="Pass mail" />
      <input type="text" id="editRefreshToken" placeholder="Refresh Token" />
      <input type="text" id="editClientId" placeholder="Client ID" />
      <input type="text" id="editNote" placeholder="Ghi ch√∫" />
      <!-- NEW: 2FA Secret edit -->
      <input type="text" id="edit2FASecret" placeholder="2FA Secret (Base32)" />
      <button onclick="saveEditedAccount()">L∆∞u thay ƒë·ªïi</button>
      <button onclick="toggleEditAccount()">H·ªßy</button>
    </div>

    <div id="moveAccountForm" class="form-container" style="display: none;">
      <label for="targetGroupSelect">Ch·ªçn nh√≥m mu·ªën chuy·ªÉn ƒë·∫øn:</label>
      <select id="targetGroupSelect">
        <option value="">-- Ch·ªçn nh√≥m --</option>
      </select>
      <button onclick="confirmMove()">Chuy·ªÉn</button>
      <button onclick="toggleMoveForm()">H·ªßy</button>
    </div>

    <div class="account-box" id="accountInfo" style="display:none">
      <div class="field">
        <div class="label">User / Password:</div>
        <div class="field-content" style="flex-wrap: wrap; gap: 5px;">
          <div style="display: flex; flex: 1 1 45%; align-items: center; gap: 5px; min-width: 150px;">
            <div class="value" id="user"></div>
            <button class="copy-btn" onclick="copy('user')">Copy</button>
          </div>
          <div style="display: flex; flex: 1 1 45%; align-items: center; gap: 5px; min-width: 150px;">
            <div class="value" id="password"></div>
            <button class="copy-btn" onclick="copy('password')">Copy</button>
          </div>
        </div>
      </div>
      <div class="field">
        <div class="label">Email: <span id="emailProvider" class="provider-label"></span></div>
        <div class="field-content no-wrap">
          <div class="scroll-box">
            <div class="value" id="email"></div>
          </div>
          <button class="copy-btn" onclick="copy('email')">Copy</button>
        </div>
      </div>
      <div class="field">
        <div class="label">OTP email:</div>
        <div class="field-content">
          <div style="display: flex; flex: 1 1 100%; align-items: center; gap: 5px;">
            <div class="value" id="otp_result">ƒêang t·∫£i...</div>
            <div class="spinner" id="otpSpinner"></div>
            <button class="copy-btn" onclick="copy('otp_result')">Copy</button>
          </div>
        </div>
      </div>
      <!-- NEW: 2FA (TOTP) section -->
      <div class="field">
        <div class="label">2FA (TOTP):</div>
        <div class="field-content">
          <div class="value" id="totp_code">Ch∆∞a c√≥ 2FA</div>
          <button class="copy-btn" onclick="copy('totp_code')">Copy</button>
          <button class="btn-blue" style="padding: 6px 10px; font-size: 0.75rem; border-radius: 6px;" onclick="get2FACode(true)">üîê L·∫•y 2FA</button>
          <span id="totpCountdown" class="provider-label"></span>
        </div>
      </div>

      <div class="field">
        <div class="label">Ghi ch√∫:</div>
        <div class="field-content">
          <div class="value" id="note"></div>
          <button class="btn-blue" style="padding: 6px 10px; font-size: 0.75rem; border-radius: 6px;" onclick="getOtp()">üì© L·∫•y OTP</button>
        </div>
      </div>
      <p><b>L·∫ßn l·∫•y OTP g·∫ßn nh·∫•t:</b> <span id="lastOtpTime">Ch∆∞a c√≥</span></p>
      <div class="action-button-grid">
        <button class="btn-gray" onclick="prevAccount()">‚¨Ö Tr∆∞·ªõc</button>
        <button class="btn-gray" onclick="nextAccount()">Sau ‚û°</button>
        <button class="btn-red" onclick="deleteAccount()">üóë X√≥a TK n√†y</button>
        <button class="btn-gray" onclick="toggleEditAccount()">‚úèÔ∏è S·ª≠a TK</button>
        <button class="btn-blue" onclick="bindDevice()">üì± G√°n thi·∫øt b·ªã</button>
        <button class="btn-red" onclick="unbindDevice()">‚ùå X√≥a thi·∫øt b·ªã</button>
        <button class="btn-blue" onclick="checkDevice()">üîç Ki·ªÉm tra t√†i kho·∫£n ƒë√£ g√°n</button>
      </div>
    </div>

    <div class="add-action-buttons">
      <button class="btn-blue" onclick="toggleAddGroupForm()">‚ûïAdd Group</button>
      <button class="btn-red" onclick="deleteGroup()">üóëDel Group</button>
      <div style="position: relative;">
        <button class="btn-gray" onclick="toggleMoveMenu()">üîÄMove Group</button>
        <div id="moveMenu" style="position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; z-index: 1000;">
          <button onclick="moveSingleAccount()" style="width: 100%; text-align: left;">üîÅ Chuy·ªÉn t√†i kho·∫£n ƒëang ch·ªçn</button>
          <button onclick="moveSelectedAccounts()" style="width: 100%; text-align: left;">‚úÖ Chuy·ªÉn c√°c t√†i kho·∫£n ƒë√£ tick</button>
          <button onclick="moveAllAccounts()" style="width: 100%; text-align: left;">üì¶ Chuy·ªÉn to√†n b·ªô t√†i kho·∫£n</button>
        </div>
      </div>
      <div style="position: relative;">
        <button class="btn-gray" onclick="toggleAddAccountMenu()">‚ûïAdd Account</button>
        <div id="addAccountMenu" style="position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; z-index: 1000;">
          <button onclick="toggleAddAccountForm()" style="width: 100%; text-align: left;">üìù Th√™m th·ªß c√¥ng</button>
          <button onclick="toggleAddAccountLineForm()" style="width: 100%; text-align: left;">üìã Th√™m nhi·ªÅu d√≤ng</button>
        </div>
      </div>
    </div>
  </div>

  <div id="alertBox" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.75); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; z-index: 9999; display: none; transition: opacity 0.3s ease;">
    <span id="alertMessage"></span>
    <button onclick="hideToast()" style="margin-left: 10px; background: transparent; color: white; border: none; cursor: pointer;">Close</button>
  </div>

  <div id="confirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%; box-shadow:0 0 10px red; text-align:center; animation: shake 0.3s;">
      <h3 style="color: red; font-size: 20px;">‚ö†Ô∏è X√°c nh·∫≠n x√≥a nh√≥m</h3>
      <p id="confirmText" style="margin-bottom: 20px; color:#333;"></p>
      <button onclick="confirmDeleteGroup()" style="background:#dc3545; color:white; padding:10px 15px; border:none; border-radius:6px;">X√ìA</button>
      <button onclick="closeConfirmModal()" style="margin-left:10px; background:#ccc; padding:10px 15px; border:none; border-radius:6px;">H·ªßy</button>
    </div>
  </div>

  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsSHA fallback for HMAC-SHA1 if WebCrypto isn't available (e.g., file:// or non-HTTPS) -->
  <script src="https://cdn.jsdelivr.net/npm/jssha/dist/sha1.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_ACTUAL_API_KEY",
      authDomain: "acctiktok-34c22.firebaseapp.com",
      databaseURL: "https://acctiktok-34c22-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "acctiktok-34c22",
      storageBucket: "acctiktok-34c22.appspot.com",
      messagingSenderId: "788776632508",
      appId: "1:788776632508:web:c94467809ce41f68027ceb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let fullAccountList = [];
    let deviceId = localStorage.getItem('deviceId') || 'device_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('deviceId', deviceId);
    let moveMode = 'single';
    let mailTmDomains = [];
    let groupToDelete = "";
    let totpTimer = null; // NEW: interval for auto-update TOTP

    function sanitizeEmail(email) {
      return email.replace(/[@.]/g, match => match === '@' ? '-at-' : '-dot-');
    }

    function getEmailProvider(email) {
      if (!email || !email.includes('@')) return null;
      const domain = email.split('@')[1].toLowerCase();
      if (["hotmail.com", "outlook.com"].includes(domain)) return 'hotmail';
      if (domain === 'gmail.com') return 'gmail';
      return 'mailtm';
    }

    function loadGroups() {
      db.ref("group_names").once("value").then(snapshot => {
        const groupNames = snapshot.val() || {};
        const groupSelect = document.getElementById("groupSelect");
        groupSelect.innerHTML = '<option value="">Ch·ªçn nh√≥m</option>';
        for (const group in groupNames) {
          if (groupNames[group] === true) {
            const option = document.createElement("option");
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
          }
        }
        loadLastSelection();
      }).catch(error => {
        console.error("Error loading groups:", error);
        showToast("L·ªói t·∫£i danh s√°ch nh√≥m!");
      });
    }

    function loadLastSelection() {
      db.ref(`user_selections/${deviceId}`).once("value").then(snapshot => {
        const selection = snapshot.val();
        if (selection && selection.group) {
          document.getElementById("groupSelect").value = selection.group;
          changeGroup(selection.accountIndex || 0);
        } else if (document.getElementById("groupSelect").options.length > 1) {
          document.getElementById("groupSelect").value = document.getElementById("groupSelect").options[1].value;
          changeGroup();
        }
      }).catch(error => {
        console.error("Error loading last selection:", error);
        if (document.getElementById("groupSelect").options.length > 1) {
          document.getElementById("groupSelect").value = document.getElementById("groupSelect").options[1].value;
          changeGroup();
        }
      });
    }

    function saveSelection(group, accountIndex) {
      db.ref(`user_selections/${deviceId}`).set({ group, accountIndex }).catch(error => console.error("Error saving selection:", error));
    }

    function changeGroup(selectedIndex = 0) {
      const group = document.getElementById("groupSelect").value;
      if (!group) return;
      db.ref("accounts/" + group).once("value").then(snapshot => {
        const list = snapshot.val() || [];
        fullAccountList = Array.isArray(list) ? list : [];
        document.getElementById("accountSearch").value = "";
        renderAccountList();
        const accountInfo = document.getElementById("accountInfo");
        if (fullAccountList.length > 0) {
          const index = Math.min(selectedIndex, fullAccountList.length - 1);
          document.getElementById("accountSelect").value = index;
          updateAccountInfo(fullAccountList[index]);
          saveSelection(group, index);
          accountInfo.style.display = "block";
        } else {
          accountInfo.style.display = "none";
        }
        document.getElementById("accountCount").textContent = `#TK: ${fullAccountList.length}`;
      }).catch(error => {
        console.error("Error loading accounts for group:", error);
        showToast("L·ªói t·∫£i danh s√°ch t√†i kho·∫£n!");
      });
    }

    function renderAccountList() {
      const accountSelect = document.getElementById("accountSelect");
      accountSelect.innerHTML = '';
      fullAccountList.forEach((acc, i) => {
        const parts = acc.split("|");
        const display = parts[2] || parts[0] || "No identifier";
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `#${i + 1} - ${display}`;
        accountSelect.appendChild(option);
      });
      document.getElementById("accountCount").textContent = `#TK: ${fullAccountList.length}`;
      document.getElementById("accountInfo").style.display = fullAccountList.length > 0 ? "block" : "none";
    }

    function filterAccounts() {
      const keyword = document.getElementById("accountSearch").value.toLowerCase().trim();
      const searchAll = document.getElementById("searchAllGroups").checked;
      const accountSelect = document.getElementById("accountSelect");
      accountSelect.innerHTML = '';

      if (searchAll) {
        db.ref("accounts").once("value").then(snapshot => {
          const allData = snapshot.val() || {};
          const matches = [];
          for (const group in allData) {
            const accounts = allData[group] || [];
            accounts.forEach((acc, idx) => {
              const parts = acc.split("|");
              const user = (parts[0] || "").toLowerCase();
              const password = (parts[1] || "").toLowerCase();
              const email = (parts[2] || "").toLowerCase();
              if (user.includes(keyword) || password.includes(keyword) || email.includes(keyword)) {
                matches.push({ group, index: idx, acc, display: parts[2] || parts[0] || "No identifier" });
              }
            });
          }
          fullAccountList = matches.map(m => m.acc);
          matches.forEach((match, i) => {
            const opt = document.createElement("option");
            const value = JSON.stringify({ group: match.group, index: match.index });
            opt.value = value;
            opt.textContent = `#${i + 1} - ${match.display} (${match.group})`;
            accountSelect.appendChild(opt);
          });
          const accountInfo = document.getElementById("accountInfo");
          if (matches.length > 0) {
            updateAccountInfo(matches[0].acc);
            saveSelection(matches[0].group, matches[0].index);
            accountInfo.style.display = "block";
          } else {
            accountInfo.style.display = "none";
          }
          document.getElementById("accountCount").textContent = `#TK: ${matches.length}`;
        });
      } else {
        const filtered = fullAccountList.filter((acc) => {
          const parts = acc.split("|");
          const user = (parts[0] || "").toLowerCase();
          const password = (parts[1] || "").toLowerCase();
          const email = (parts[2] || "").toLowerCase();
          return user.includes(keyword) || password.includes(keyword) || email.includes(keyword);
        });
        filtered.forEach((acc, i) => {
          const parts = acc.split("|");
          const display = parts[2] || parts[0] || "No identifier";
          const option = document.createElement("option");
          option.value = i;
          option.textContent = `#${i + 1} - ${display}`;
          accountSelect.appendChild(option);
        });
        const accountInfo = document.getElementById("accountInfo");
        if (filtered.length > 0) {
          updateAccountInfo(filtered[0]);
          accountInfo.style.display = "block";
        } else {
          accountInfo.style.display = "none";
        }
        document.getElementById("accountCount").textContent = `#TK: ${filtered.length}`;
      }
    }

    function changeAccount() {
      const selected = document.getElementById("accountSelect").value;
      const searchAll = document.getElementById("searchAllGroups").checked;
      if (searchAll) {
        try {
          const parsed = JSON.parse(selected);
          const group = parsed.group;
          const index = parsed.index;
          if (!group || typeof index !== "number") { showToast("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh t√†i kho·∫£n!"); return; }
          db.ref("accounts/" + group).once("value").then(snapshot => {
            const list = snapshot.val() || [];
            if (Array.isArray(list) && index >= 0 && index < list.length) {
              updateAccountInfo(list[index]);
              saveSelection(group, index);
            } else {
              showToast("T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i trong nh√≥m!");
            }
          }).catch(error => {
            console.error("L·ªói t·∫£i t√†i kho·∫£n t·ª´ Firebase:", error);
            showToast("L·ªói khi t·∫£i th√¥ng tin t√†i kho·∫£n!");
          });
        } catch (err) {
          console.error("L·ªói ph√¢n t√≠ch JSON:", err);
          showToast("D·ªØ li·ªáu t√†i kho·∫£n kh√¥ng h·ª£p l·ªá!");
        }
      } else {
        const index = parseInt(selected, 10);
        const group = document.getElementById("groupSelect").value;
        if (!group || isNaN(index) || !fullAccountList || !Array.isArray(fullAccountList)) { showToast("Vui l√≤ng ch·ªçn nh√≥m ho·∫∑c t√†i kho·∫£n h·ª£p l·ªá!"); return; }
        if (index >= 0 && index < fullAccountList.length) {
          updateAccountInfo(fullAccountList[index]);
          saveSelection(group, index);
        } else {
          showToast("T√†i kho·∫£n kh√¥ng h·ª£p l·ªá trong nh√≥m!");
        }
      }
    }

    function prevAccount() {
      const currentIndex = parseInt(document.getElementById("accountSelect").value) || 0;
      const newIndex = Math.max(0, currentIndex - 1);
      document.getElementById("accountSelect").value = newIndex;
      changeAccount();
    }
    function nextAccount() {
      const currentIndex = parseInt(document.getElementById("accountSelect").value) || 0;
      const newIndex = Math.min(fullAccountList.length - 1, currentIndex + 1);
      document.getElementById("accountSelect").value = newIndex;
      changeAccount();
    }

    function updateAccountInfo(line) {
      const parts = line.split("|");
      const acc = {
        user: parts[0] || "",
        password: parts[1] || "",
        email: parts[2] || "",
        pass_mail: parts[3] || "",
        refresh_token: parts[4] || "",
        client_id: parts[5] || "",
        note: parts[6] || "",
        twofa_secret: parts[7] || "" // NEW
      };
      window.currentAccount = acc;

      document.getElementById("user").textContent = acc.user || "N/A";
      document.getElementById("password").textContent = acc.password || "N/A";
      document.getElementById("email").textContent = acc.email || "N/A";
      document.getElementById("note").textContent = acc.note || "";

      const provider = getEmailProvider(acc.email);
      const providerLabel = document.getElementById("emailProvider");
      if (provider === 'hotmail') { providerLabel.textContent = "(Hotmail)"; document.getElementById("otp_result").textContent = "ƒêang t·∫£i..."; }
      else if (provider === 'gmail') { providerLabel.textContent = "(Gmail)"; document.getElementById("otp_result").textContent = "ƒêang t·∫£i..."; }
      else if (provider === 'mailtm') { providerLabel.textContent = "(mail.tm)"; document.getElementById("otp_result").textContent = "ƒêang t·∫£i..."; }
      else { providerLabel.textContent = ""; document.getElementById("otp_result").textContent = acc.email ? "Email kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£" : "Kh√¥ng c√≥ email, kh√¥ng th·ªÉ l·∫•y OTP"; }

      document.getElementById("accountInfo").style.display = "block";

      if (acc.email) {
        const key = sanitizeEmail(acc.email);
        db.ref(`otpTimestamps/${key}`).once("value").then(snapshot => {
          const data = snapshot.val();
          document.getElementById("lastOtpTime").textContent = data && data.lastOtpTime ? new Date(data.lastOtpTime).toLocaleString("vi-VN") : "Ch∆∞a c√≥";
        }).catch(error => {
          console.error("L·ªói t·∫£i th·ªùi gian OTP:", error);
          document.getElementById("lastOtpTime").textContent = "L·ªói t·∫£i";
        });
      } else {
        document.getElementById("lastOtpTime").textContent = "N/A";
      }

      // NEW: start auto TOTP updater
      startTotpAutoUpdate();
    }

    async function getHotmailOrGmailOtp(acc, key) {
      try {
        const response = await fetch("https://tool.unlimitmail.com/api/get_code_oauth2", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "tiktok",
            email: acc.email,
            pass_mail: acc.pass_mail || "",
            refresh_token: acc.refresh_token || "",
            client_id: acc.client_id || ""
          })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data = await response.json();
        const code = data.code || "No OTP received";
        document.getElementById("otp_result").textContent = code;
        await db.ref(`otpTimestamps/${key}`).update({ lastOtpTime: new Date().toISOString(), otpCode: code });
        showToast("OTP retrieved successfully!");
      } catch (error) {
        console.error("Error getting OTP:", error);
        showToast(`Failed to get OTP from ${getEmailProvider(acc.email) === 'hotmail' ? 'Hotmail' : 'Gmail'}!`);
        document.getElementById("otp_result").textContent = `Error retrieving OTP: ${error.message}`;
      }
    }

    async function getMailtmOtp(acc, key, retries = 3, pollCount = 0) {
      if (pollCount >= 5) {
        document.getElementById('otp_result').textContent = "No OTP received after 5 attempts";
        showToast("No OTP received from mail.tm after 5 attempts!");
        return;
      }
      try {
        const loginResponse = await fetch("https://api.mail.tm/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address: acc.email, password: "1111" })
        });
        const loginData = await loginResponse.json();
        if (!loginResponse.ok || !loginData.token) {
          if (retries > 0) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            return getMailtmOtp(acc, key, retries - 1, pollCount);
          }
          throw new Error(`‚ùå Login th·∫•t b·∫°i: ${loginResponse.statusText}`);
        }
        const token = loginData.token;
        const headers = { "Authorization": `Bearer ${token}` };
        const msgResp = await fetch("https://api.mail.tm/messages", { headers });
        const msgJson = await msgResp.json();
        if (!msgJson["hydra:member"] || msgJson["hydra:member"].length === 0) {
          await new Promise(resolve => setTimeout(resolve, 5000));
          return getMailtmOtp(acc, key, retries, pollCount + 1);
        }
        const msgId = msgJson["hydra:member"][0].id;
        const messageResponse = await fetch(`https://api.mail.tm/messages/${msgId}`, { headers });
        const message = await messageResponse.json();
        const otpMatch = message.text.match(/\b\d{4,8}\b/);
        const code = otpMatch ? otpMatch[0] : "Kh√¥ng t√¨m th·∫•y OTP";
        document.getElementById('otp_result').textContent = code;
        await db.ref(`otpTimestamps/${key}`).update({ lastOtpTime: new Date().toISOString(), otpCode: code });
        showToast("OTP retrieved successfully!");
      } catch (error) {
        console.error("‚ùå L·ªói khi l·∫•y OTP:", error);
        document.getElementById('otp_result').textContent = `L·ªói: ${error.message}`;
        showToast("L·ªói khi l·∫•y OTP t·ª´ mail.tm!");
      }
    }

    async function getOtp() {
      const mailAccount = window.currentAccount;
      if (!mailAccount || !mailAccount.email) { showToast("Cannot retrieve OTP: No email provided!"); document.getElementById('otp_result').textContent = "No email provided"; return; }
      document.getElementById('otpSpinner').style.display = "inline-block";
      document.getElementById('otp_result').textContent = "ƒêang t·∫£i...";
      const key = sanitizeEmail(mailAccount.email);
      const provider = getEmailProvider(mailAccount.email);
      try {
        if (provider === 'hotmail' || provider === 'gmail') {
          await getHotmailOrGmailOtp(mailAccount, key);
        } else if (provider === 'mailtm') {
          await getMailtmOtp(mailAccount, key);
        } else {
          showToast("Email provider not supported!");
          document.getElementById('otp_result').textContent = "Invalid email provider";
        }
      } finally {
        document.getElementById('otpSpinner').style.display = "none";
      }
    }

    // ====== NEW: 2FA (TOTP) helpers ======
    function base32ToBytes(str) {
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      const clean = (str || '').toUpperCase().replace(/[^A-Z2-7]/g, '');
      let bits = 0, value = 0;
      const out = [];
      for (let i = 0; i < clean.length; i++) {
        const idx = alphabet.indexOf(clean[i]);
        if (idx === -1) continue;
        value = (value << 5) | idx;
        bits += 5;
        if (bits >= 8) {
          bits -= 8;
          out.push((value >> bits) & 0xff);
        }
      }
      return new Uint8Array(out);
    }

    async function hmacSHA1(keyBytes, dataBytes) {
      if (window.crypto && window.crypto.subtle) {
        const key = await crypto.subtle.importKey('raw', keyBytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
        const sig = await crypto.subtle.sign('HMAC', key, dataBytes);
        return new Uint8Array(sig);
      } else if (window.jsSHA) {
        const shaObj = new jsSHA('SHA-1', 'ARRAYBUFFER');
        shaObj.setHMACKey(keyBytes, 'ARRAYBUFFER');
        shaObj.update(dataBytes);
        const sig = shaObj.getHMAC('ARRAYBUFFER');
        return new Uint8Array(sig);
      } else {
        throw new Error('Kh√¥ng c√≥ WebCrypto ho·∫∑c jsSHA ƒë·ªÉ t·∫°o HMAC-SHA1');
      }
    }

    async function generateTOTP(secretBase32, timestampSec = Math.floor(Date.now() / 1000), step = 30, digits = 6) {
      const key = base32ToBytes(secretBase32);
      if (!key.length) throw new Error('2FA secret kh√¥ng h·ª£p l·ªá');
      const counter = Math.floor(timestampSec / step);
      const counterBytes = new Uint8Array(8);
      let tmp = counter;
      for (let i = 7; i >= 0; i--) { counterBytes[i] = tmp & 0xff; tmp = Math.floor(tmp / 256); }
      const hmac = await hmacSHA1(key, counterBytes);
      const offset = hmac[hmac.length - 1] & 0x0f;
      const code = ((hmac[offset] & 0x7f) << 24) | (hmac[offset + 1] << 16) | (hmac[offset + 2] << 8) | (hmac[offset + 3]);
      const otp = (code % 1e6).toString().padStart(digits, '0');
      return otp;
    }

    function clearTotpTimer() { if (totpTimer) { clearInterval(totpTimer); totpTimer = null; } }

    function startTotpAutoUpdate() {
      clearTotpTimer();
      const sec = (window.currentAccount && (window.currentAccount.twofa_secret || window.currentAccount.twofa || '')) || '';
      const codeEl = document.getElementById('totp_code');
      const cdEl = document.getElementById('totpCountdown');
      if (!sec) { codeEl.textContent = 'Ch∆∞a c√≥ 2FA'; cdEl.textContent = ''; return; }
      const tick = async () => {
        const now = Date.now();
        const remaining = 30 - Math.floor((now / 1000) % 30);
        cdEl.textContent = `(${remaining}s)`;
        try {
          const code = await generateTOTP(sec, Math.floor(now / 1000));
          codeEl.textContent = code;
        } catch (e) {
          codeEl.textContent = '2FA secret kh√¥ng h·ª£p l·ªá';
          cdEl.textContent = '';
        }
      };
      tick();
      totpTimer = setInterval(tick, 1000);
    }

    async function get2FACode(manual = false) {
      const sec = (window.currentAccount && (window.currentAccount.twofa_secret || window.currentAccount.twofa || '')) || '';
      if (!sec) { showToast('Ch∆∞a c√≥ 2FA secret cho t√†i kho·∫£n n√†y!'); return; }
      try {
        const code = await generateTOTP(sec);
        document.getElementById('totp_code').textContent = code;
        if (manual) showToast('ƒê√£ t·∫°o m√£ 2FA!');
      } catch (e) { showToast(e.message || 'Kh√¥ng t·∫°o ƒë∆∞·ª£c m√£ 2FA'); }
    }

    function copy(id) {
      const text = document.getElementById(id).textContent;
      if (!text || text === 'N/A') { showToast("No valid data to copy!"); return; }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast("Copied successfully!")).catch(err => { console.error("Clipboard API failed, fallback...", err); fallbackCopy(text); });
      } else { fallbackCopy(text); }
    }

    function fallbackCopy(text) {
      const textarea = document.createElement("textarea");
      textarea.value = text; textarea.style.position = "fixed"; textarea.style.opacity = 0;
      document.body.appendChild(textarea);
      textarea.focus(); textarea.select();
      try { const success = document.execCommand('copy'); showToast(success ? "Copied!" : "Copy failed!"); }
      catch (err) { console.error("Fallback copy error:", err); showToast("Copy not supported on this device."); }
      document.body.removeChild(textarea);
    }

    function showToast(message) {
      const alertToast = document.getElementById('alertBox');
      const alertMessage = document.getElementById('alertMessage');
      alertMessage.textContent = message;
      alertToast.style.display = 'inline-block';
      alertToast.style.opacity = '1';
      setTimeout(() => { alertToast.style.opacity = '0'; setTimeout(() => alertToast.style.display = 'none', 300); }, 3000);
    }
    function hideToast() { const alertToast = document.getElementById('alertBox'); alertToast.style.opacity = '0'; setTimeout(() => alertToast.style.display = 'none', 300); }

    function toggleAddGroupForm() {
      const groupForm = document.getElementById("addGroupForm");
      groupForm.style.display = groupForm.style.display === 'block' ? 'none' : 'block';
      document.getElementById("newGroupName").value = "";
    }

    function addGroup() {
      const groupName = document.getElementById('newGroupName').value.trim();
      if (!groupName) { showToast("Please enter a valid group name!"); return; }
      db.ref('group_names/' + groupName).set(true).then(() => {
        db.ref('accounts/' + groupName).set([]).then(() => { loadGroups(); toggleAddGroupForm(); showToast(`Added group: ${groupName}`); })
        .catch(error => { console.error("Error creating group accounts:", error); showToast("Failed to create group!"); });
      }).catch(error => { console.error("Error adding group:", error); showToast("Failed to add group!"); });
    }

    function toggleAddAccountMenu() {
      const menu = document.getElementById('addAccountMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      setTimeout(() => { if (menu.style.display === 'block') menu.style.display = 'none'; }, 4000);
    }

    function toggleAddAccountForm() {
      const accountForm = document.getElementById("addAccountForm");
      const lineForm = document.getElementById("addAccountLineForm");
      accountForm.style.display = accountForm.style.display === 'block' ? 'none' : 'block';
      if (accountForm.style.display === 'block') { lineForm.style.display = 'none'; }
      document.getElementById('newUser').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('newEmail').value = '';
      document.getElementById('newPassMail').value = '';
      document.getElementById('newRefreshToken').value = '';
      document.getElementById('newClientId').value = '';
      document.getElementById('newNote').value = '';
      document.getElementById('new2FASecret').value = '';
      document.getElementById('addAccountMenu').style.display = 'none';
    }

    function addAccount() {
      const group = document.getElementById('groupSelect').value;
      if (!group) { showToast("Please select a valid group!"); return; }
      const user = document.getElementById('newUser').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const passMail = document.getElementById('newPassMail').value.trim();
      const refreshToken = document.getElementById('newRefreshToken').value.trim();
      const clientId = document.getElementById('newClientId').value.trim();
      const note = document.getElementById('newNote').value.trim();
      const twofa = document.getElementById('new2FASecret').value.trim();

      // Ch·ªâ y√™u c·∫ßu password + (user ho·∫∑c email)
      if (!password || (!user && !email)) { showToast("Vui l√≤ng nh·∫≠p √≠t nh·∫•t Password v√† User ho·∫∑c Email!"); return; }
      if (email && !getEmailProvider(email)) { showToast("Email ph·∫£i l√† d·∫°ng h·ª£p l·ªá: Hotmail, Gmail, ho·∫∑c mail.tm!"); return; }

      const accountString = `${user}|${password}|${email}|${passMail}|${refreshToken}|${clientId}|${note}|${twofa}`;
      db.ref('accounts/' + group).once('value').then(res => {
        const accounts = res.val() || [];
        if (accounts.includes(accountString)) { showToast("Account already exists in this group!"); return; }
        accounts.push(accountString);
        db.ref('accounts/' + group).set(accounts).then(() => { changeGroup(); toggleAddAccountForm(); showToast(`Added account to group: ${group}`); })
        .catch(error => { console.error("Error adding account:", error); showToast("Failed to add account!"); });
      }).catch(error => { console.error("Error fetching accounts:", error); showToast("Error accessing accounts!"); });
    }

    function toggleAddAccountLineForm() {
      const lineForm = document.getElementById('addAccountLineForm');
      const accountForm = document.getElementById('addAccountForm');
      lineForm.style.display = lineForm.style.display === 'block' ? 'none' : 'block';
      if (lineForm.style.display === 'block') { accountForm.style.display = 'none'; }
      document.getElementById('accountLine').value = '';
      document.getElementById('addAccountMenu').style.display = 'none';
    }

    function addAccountFromLine() {
      const group = document.getElementById('groupSelect').value;
      if (!group) { showToast("No group selected!"); return; }
      const linesRaw = document.getElementById('accountLine').value.trim();
      const accountLines = linesRaw.split('\n').filter(line => line.includes('|'));
      if (!accountLines.length) { showToast("Please enter at least one valid account line!"); return; }
      db.ref('accounts/' + group).once('value').then(res => {
        const accounts = res.val() || [];
        const newAccounts = accountLines.map(line => {
          const parts = line.split('|');
          if (parts.length < 2) return null; // ph·∫£i c√≥ user/pass t·ªëi thi·ªÉu
          const user = parts[0]?.trim() || '';
          const password = parts[1]?.trim() || '';
          const email = parts[2]?.trim() || '';
          const passMail = parts[3]?.trim() || '';
          const refreshToken = parts[4]?.trim() || '';
          const clientId = parts[5]?.trim() || '';
          const note = parts[6]?.trim() || '';
          const twofa = parts[7]?.trim() || '';
          if (!password || (!user && !email)) return null;
          if (email && !getEmailProvider(email)) return null;
          const accountString = `${user}|${password}|${email}|${passMail}|${refreshToken}|${clientId}|${note}|${twofa}`;
          if (accounts.includes(accountString)) return null;
          return accountString;
        }).filter(Boolean);
        if (!newAccounts.length) { showToast("No valid or new accounts found in input!"); return; }
        accounts.push(...newAccounts);
        db.ref('accounts/' + group).set(accounts).then(() => { changeGroup(); toggleAddAccountLineForm(); showToast(`Added ${newAccounts.length} accounts to ${group}!`); })
        .catch(error => { console.error("Error adding accounts:", error); showToast("Failed to add accounts!"); });
      }).catch(error => { console.error("Error fetching accounts:", error); showToast("Error accessing accounts!"); });
    }

    function toggleMoveMenu() {
      const menu = document.getElementById('moveMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      setTimeout(() => { if (menu.style.display === 'block') menu.style.display = 'none'; }, 4000);
    }

    function moveSingleAccount() { moveMode = 'single'; moveAccount(); }
    function moveSelectedAccounts() { moveMode = 'selected'; moveAccount(); }
    function moveAllAccounts() { moveMode = 'all'; moveAccount(); }

    function moveAccount() {
      const groupFrom = document.getElementById('groupSelect').value;
      if (!groupFrom) { showToast("Please select a source group!"); return; }
      const targetSelect = document.getElementById('targetGroupSelect');
      targetSelect.innerHTML = '<option value="">-- Ch·ªçn nh√≥m --</option>';
      db.ref('group_names').once('value').then(res => {
        const groups = res.val() || {};
        for (const name in groups) { if (groups[name] && name !== groupFrom) { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; targetSelect.appendChild(opt); } }
        toggleMoveForm();
      }).catch(error => { console.error("Error loading groups:", error); showToast("Failed to load groups!"); });
    }

    function toggleMoveForm() { const moveForm = document.getElementById('moveAccountForm'); moveForm.style.display = moveForm.style.display === 'block' ? 'none' : 'block'; }

    function confirmMove() {
      const groupFrom = document.getElementById('groupSelect').value;
      const groupTo = document.getElementById('targetGroupSelect').value;
      if (!groupFrom || !groupTo) { showToast("Missing source or target group!"); return; }
      if (moveMode === 'single') {
        const index = parseInt(document.getElementById('accountSelect').value);
        if (isNaN(index)) { showToast("Please select an account to move!"); return; }
        db.ref('accounts/' + groupFrom).once('value').then(res => {
          const accounts = res.val() || [];
          const account = accounts[index]; if (!account) { showToast("Account not found!"); return; }
          db.ref('accounts/' + groupTo).once('value').then(resTo => {
            const targetAccounts = resTo.val() || [];
            targetAccounts.push(account);
            db.ref('accounts/' + groupTo).set(targetAccounts).then(() => {
              accounts.splice(index, 1);
              db.ref('accounts/' + groupFrom).set(accounts).then(() => { showToast("Account moved successfully!"); toggleMoveForm(); changeGroup(Math.max(0, index - 1)); });
            });
          });
        }).catch(error => { console.error("Error moving account:", error); showToast("Failed to move account!"); });
      } else if (moveMode === 'selected') {
        const selectedOptions = Array.from(document.getElementById("accountSelect").options).filter(opt => opt.selected && opt.value !== "").map(opt => parseInt(opt.value));
        if (!selectedOptions.length) { showToast("No accounts selected!"); return; }
        db.ref('accounts/' + groupFrom).once('value').then(res => {
          const accounts = res.val() || [];
          const selectedAccounts = selectedOptions.map(i => accounts[i]);
          db.ref('accounts/' + groupTo).once('value').then(resTo => {
            const targetAccounts = resTo.val() || [];
            targetAccounts.push(...selectedAccounts);
            db.ref('accounts/' + groupTo).set(targetAccounts).then(() => {
              const remainingAccounts = accounts.filter((_, i) => !selectedOptions.includes(i));
              db.ref('accounts/' + groupFrom).set(remainingAccounts).then(() => { showToast(`Moved ${selectedOptions.length} accounts!`); toggleMoveForm(); changeGroup(); });
            });
          });
        }).catch(error => { console.error("Error moving selected accounts:", error); showToast("Failed to move accounts!"); });
      } else if (moveMode === 'all') {
        db.ref('accounts/' + groupFrom).once('value').then(res => {
          const accounts = res.val() || [];
          if (!accounts.length) { showToast("No accounts to move!"); toggleMoveForm(); return; }
          db.ref('accounts/' + groupTo).once('value').then(resTo => {
            const targetAccounts = resTo.val() || [];
            targetAccounts.push(...accounts);
            db.ref('accounts/' + groupTo).set(targetAccounts).then(() => {
              db.ref('accounts/' + groupFrom).set([]).then(() => { showToast(`Moved ${accounts.length} accounts!`); toggleMoveForm(); changeGroup(); });
            });
          });
        }).catch(error => { console.error("Error moving all accounts:", error); showToast("Failed to move accounts!"); });
      }
    }

    function deleteAccount() {
      const group = document.getElementById('groupSelect').value;
      const index = parseInt(document.getElementById('accountSelect').value);
      if (!group || isNaN(index)) { showToast("Please select an account to delete!"); return; }
      if (confirm('Are you sure you want to delete this account?')) {
        db.ref('accounts/' + group).once('value').then(res => {
          const accounts = res.val() || [];
          accounts.splice(index, 1);
          db.ref('accounts/' + group).set(accounts).then(() => { changeGroup(Math.max(0, index - 1)); showToast("Account deleted successfully!"); })
          .catch(error => { console.error("Error deleting account:", error); showToast("Failed to delete account!"); });
        });
      }
    }

    function deselectAllAccounts() {
      const select = document.getElementById("accountSelect");
      for (let i = 0; i < select.options.length; i++) { select.options[i].selected = false; }
      showToast("ƒê√£ b·ªè ch·ªçn t·∫•t c·∫£ t√†i kho·∫£n");
    }

    function deleteGroup() {
      const group = document.getElementById('groupSelect').value;
      if (!group) { showToast("Vui l√≤ng ch·ªçn nh√≥m ƒë·ªÉ x√≥a!"); return; }
      groupToDelete = group;
      document.getElementById("confirmText").innerText = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√≥m "${group}"? T·∫•t c·∫£ t√†i kho·∫£n b√™n trong s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.`;
      document.getElementById("confirmModal").style.display = "flex";
      const alertSound = document.getElementById("alertSound");
      if (alertSound) alertSound.play().catch(() => {});
    }

    function confirmDeleteGroup() {
      db.ref('group_names/' + groupToDelete).remove()
        .then(() => db.ref('accounts/' + groupToDelete).remove())
        .then(() => { showToast(`ƒê√£ x√≥a nh√≥m "${groupToDelete}"!`); groupToDelete = ""; loadGroups(); closeConfirmModal(); })
        .catch(err => { console.error("L·ªói khi x√≥a nh√≥m:", err); showToast("X√≥a nh√≥m th·∫•t b·∫°i!"); });
    }
    function closeConfirmModal() { document.getElementById("confirmModal").style.display = "none"; }

    function toggleEditAccount() {
      const form = document.getElementById("editAccountForm");
      const isOpen = form.style.display === "block";
      form.style.display = isOpen ? "none" : "block";
      if (!isOpen && window.currentAccount) {
        document.getElementById("editUser").value = currentAccount.user || "";
        document.getElementById("editPassword").value = currentAccount.password || "";
        document.getElementById("editEmail").value = currentAccount.email || "";
        document.getElementById("editPassMail").value = currentAccount.pass_mail || "";
        document.getElementById("editRefreshToken").value = currentAccount.refresh_token || "";
        document.getElementById("editClientId").value = currentAccount.client_id || "";
        document.getElementById("editNote").value = currentAccount.note || "";
        document.getElementById("edit2FASecret").value = currentAccount.twofa_secret || "";
      }
    }

    function saveEditedAccount() {
      const group = document.getElementById('groupSelect').value;
      const index = parseInt(document.getElementById("accountSelect").value);
      if (!group || isNaN(index)) { showToast("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c t√†i kho·∫£n ƒë·ªÉ s·ª≠a!"); return; }
      const user = document.getElementById("editUser").value.trim();
      const password = document.getElementById("editPassword").value.trim();
      const email = document.getElementById("editEmail").value.trim();
      const passMail = document.getElementById("editPassMail").value.trim();
      const refreshToken = document.getElementById("editRefreshToken").value.trim();
      const clientId = document.getElementById("editClientId").value.trim();
      const note = document.getElementById("editNote").value.trim();
      const twofa = document.getElementById("edit2FASecret").value.trim();
      if (!password || (!user && !email)) { showToast("Ph·∫£i c√≥ m·∫≠t kh·∫©u v√† User ho·∫∑c Email!"); return; }
      if (email && !getEmailProvider(email)) { showToast("Email kh√¥ng h·ª£p l·ªá (ch·ªâ h·ªó tr·ª£ Gmail, Hotmail, mail.tm)"); return; }
      const newAccount = `${user}|${password}|${email}|${passMail}|${refreshToken}|${clientId}|${note}|${twofa}`;
      db.ref('accounts/' + group).once('value').then(res => {
        const accounts = res.val() || [];
        accounts[index] = newAccount;
        db.ref('accounts/' + group).set(accounts).then(() => {
          showToast("ƒê√£ c·∫≠p nh·∫≠t t√†i kho·∫£n!");
          toggleEditAccount();
          changeGroup(index);
        }).catch(error => { console.error("L·ªói khi c·∫≠p nh·∫≠t:", error); showToast("Kh√¥ng th·ªÉ l∆∞u th√¥ng tin!"); });
      });
    }

    loadGroups();

    function generateDeviceId() {
      const raw = [ navigator.userAgent, navigator.platform, screen.width + 'x' + screen.height ].join('|');
      return 'dev_' + btoa(raw).substring(0, 16);
    }
    function registerDevice() {
      const acc = window.currentAccount;
      if (!acc?.email) { showToast("Kh√¥ng c√≥ email ƒë·ªÉ g√°n thi·∫øt b·ªã!"); return; }
      const emailKey = sanitizeEmail(acc.email);
      const deviceId = localStorage.getItem('deviceId') || generateDeviceId();
      localStorage.setItem('deviceId', deviceId);
      const info = { deviceId, userAgent: navigator.userAgent, platform: navigator.platform, screen: `${screen.width}x${screen.height}`, time: new Date().toISOString() };
      firebase.database().ref(`device_logs/${emailKey}`).set(info)
        .then(() => showToast("‚úÖ ƒê√£ g√°n thi·∫øt b·ªã cho t√†i kho·∫£n!"))
        .catch(err => { console.error("L·ªói khi l∆∞u thi·∫øt b·ªã:", err); showToast("‚ùå Kh√¥ng th·ªÉ l∆∞u thi·∫øt b·ªã!"); });
    }
    function removeDevice() {
      const acc = window.currentAccount;
      if (!acc?.email) { showToast("Kh√¥ng c√≥ email ƒë·ªÉ x√≥a thi·∫øt b·ªã!"); return; }
      const emailKey = sanitizeEmail(acc.email);
      firebase.database().ref(`device_logs/${emailKey}`).remove()
        .then(() => { showToast("üóë ƒê√£ x√≥a th√¥ng tin thi·∫øt b·ªã!"); })
        .catch(err => { console.error("L·ªói khi x√≥a thi·∫øt b·ªã:", err); showToast("‚ùå Kh√¥ng th·ªÉ x√≥a thi·∫øt b·ªã!"); });
    }
    function findEmailByDeviceId() {
      const targetDeviceId = localStorage.getItem("deviceId") || generateDeviceId();
      firebase.database().ref("device_logs").once("value")
        .then(snapshot => {
          const logs = snapshot.val() || {};
          let foundEmail = null;
          for (const emailKey in logs) { const log = logs[emailKey]; if (log.deviceId === targetDeviceId) { foundEmail = emailKey; break; } }
          if (foundEmail) { showToast(`üîç Thi·∫øt b·ªã n√†y ƒë√£ g√°n v·ªõi: ${foundEmail.replace(/-at-/g, "@").replace(/-dot-/g, ".")}`); }
          else { showToast("‚ùå Thi·∫øt b·ªã n√†y ch∆∞a ƒë∆∞·ª£c g√°n t√†i kho·∫£n n√†o."); }
        })
        .catch(err => { console.error("L·ªói khi t√¨m thi·∫øt b·ªã:", err); showToast("Kh√¥ng th·ªÉ truy v·∫•n thi·∫øt b·ªã!"); });
    }
    // UI button wrappers to match existing buttons
    function bindDevice(){ registerDevice(); }
    function unbindDevice(){ removeDevice(); }
    function checkDevice(){ findEmailByDeviceId(); }
  </script>

  <div id="videoLinks" style="margin: 15px 0;">
    <h4>üé¨ Ch·ªçn Video 60 Ph√∫t TikTok:</h4>
    <div style="margin-bottom: 10px;">
      <button id="deleteModeBtn" onclick="toggleDeleteMode()">üîò B·∫≠t ch·∫ø ƒë·ªô xo√°</button>
    </div>
    <div id="videoList" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;"></div>

    <div id="addVideoForm" style="margin-top: 15px;">
      <div style="display: flex; flex-direction: row; gap: 10px;">
        <input type="text" id="newVideoTitle" placeholder="T√™n video" style="flex: 1; padding: 10px; font-size: 14px;" />
        <input type="text" id="newVideoUrl" placeholder="Link video TikTok" style="flex: 2; padding: 10px; font-size: 14px;" />
        <button onclick="addVideo()" style="padding: 10px; background-color: #4CAF50; color: white; font-size: 14px; border: none; border-radius: 6px;">‚ûï Th√™m Video</button>
      </div>
    </div>

    <script>
      let isDeleteMode = false;
      function toggleDeleteMode() {
        isDeleteMode = !isDeleteMode;
        renderVideoLinks();
        const btn = document.getElementById("deleteModeBtn");
        btn.textContent = isDeleteMode ? "üóë X√≥a video ƒë√£ ch·ªçn" : "üîò B·∫≠t ch·∫ø ƒë·ªô xo√°";
        if (isDeleteMode) {
          const delAll = document.createElement("button");
          delAll.id = "confirmDeleteBtn";
          delAll.textContent = "‚úÖ X√°c nh·∫≠n xo√° c√°c video ƒë√£ ch·ªçn";
          delAll.style = "margin-left: 10px; background-color: red; color: white; border: none; border-radius: 6px; padding: 8px;";
          delAll.onclick = confirmDeleteSelected;
          btn.parentNode.appendChild(delAll);
        } else {
          const oldBtn = document.getElementById("confirmDeleteBtn");
          if (oldBtn) oldBtn.remove();
        }
      }
      function getCurrentDate() { return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Tokyo' }); }
      function resetUsedVideos() {
        const currentDate = getCurrentDate();
        const usedToday = JSON.parse(localStorage.getItem("usedVideos") || "{}");
        const lastUsedDate = Object.keys(usedToday)[0] || currentDate;
        if (lastUsedDate !== currentDate) { localStorage.setItem("usedVideos", "{}"); }
      }
      function markVideoUsed(url) {
        const currentDate = getCurrentDate();
        let usedToday = JSON.parse(localStorage.getItem("usedVideos") || "{}");
        usedToday[currentDate] = usedToday[currentDate] || [];
        if (!usedToday[currentDate].includes(url)) { usedToday[currentDate].push(url); localStorage.setItem("usedVideos", JSON.stringify(usedToday)); }
      }
      function getStoredVideos() {
        const defaultList = [
          { title: "lite 1", url: "https://lite.tiktok.com/t/ZS6rUfPCS/" },
          { title: "lite 2", url: "https://lite.tiktok.com/t/ZS6rUywGN/" },
          { title: "lite 3", url: "https://lite.tiktok.com/t/ZS6rUjMPr/" },
          { title: "lite 4", url: "https://lite.tiktok.com/t/ZS6rUAkTU/" },
          { title: "lite 5", url: "https://lite.tiktok.com/t/ZS6rUBxQT/" },
          { title: "lite 6", url: "https://lite.tiktok.com/t/ZS6rUHbos/" },
          { title: "lite 7", url: "https://lite.tiktok.com/t/ZS6rU2cGQ/" },
          { title: "lite 8", url: "https://lite.tiktok.com/t/ZS6rUK3U8/" },
          { title: "lite 9", url: "https://lite.tiktok.com/t/ZS6rUwGGu/" },
          { title: "lite 10", url: "https://lite.tiktok.com/t/ZSARoUWeB/" },
          { title: "lite 11", url: "https://lite.tiktok.com/t/ZSARoLqm3/" },
          { title: "lite 12", url: "https://lite.tiktok.com/t/ZSARoa7RU/" },
          { title: "lite 13", url: "https://lite.tiktok.com/t/ZSARohvmk/" },
          { title: "lite 14", url: "https://lite.tiktok.com/t/ZSARo2PGU/" },
          { title: "lite 15", url: "https://lite.tiktok.com/t/ZSARoDyKm/" },
          { title: "lite 16", url: "https://lite.tiktok.com/t/ZSARokVMM/" },
          { title: "lite 17", url: "https://lite.tiktok.com/t/ZSARorA23/" },
          { title: "lite 18", url: "https://lite.tiktok.com/t/ZSARofqoK/" },
          { title: "lite 19", url: "https://lite.tiktok.com/t/ZSARomjqU/" },
          { title: "lite 20", url: "https://lite.tiktok.com/t/ZSARoSPY5/" },
          { title: "lite 21", url: "https://lite.tiktok.com/t/ZSARo5Hwq/" },
          { title: "lite 22", url: "https://lite.tiktok.com/t/ZSARoYayA/" },
          { title: "lite 23", url: "https://lite.tiktok.com/t/ZSARohcgu/" },
          { title: "lite 24", url: "https://lite.tiktok.com/t/ZSARoy3NL/" },
          { title: "lite 25", url: "https://lite.tiktok.com/t/ZSARorcGX/" },
          { title: "lite 26", url: "https://lite.tiktok.com/t/ZSARoNbJu/" },
          { title: "lite 27", url: "https://lite.tiktok.com/t/ZSARoqfsX/" },
          { title: "lite 28", url: "https://lite.tiktok.com/t/ZSA816yRM/" },
          
          { title: "thuong 1", url: "https://www.tiktok.com/@timerzxc/video/7421407239560301831" },
          { title: "thuong 2", url: "https://www.tiktok.com/@faileskeb7p/video/7389890599555566849" },
          { title: "thuong 3", url: "https://www.tiktok.com/@faileskeb7p/video/7390359695346748689" },
          { title: "thuong 4", url: "https://www.tiktok.com/@bebeushi/video/7380604897227574535" },
        ];
        const saved = localStorage.getItem("videoLinks");
        if (!saved) return defaultList;
        const savedList = JSON.parse(saved);
        const all = [...savedList];
        defaultList.forEach(def => { if (!all.some(v => v.url === def.url)) { all.push(def); } });
        return all;
      }
      function saveVideos(list) { localStorage.setItem("videoLinks", JSON.stringify(list)); }
      function renderVideoLinks() {
        const container = document.getElementById("videoList");
        container.innerHTML = "";
        resetUsedVideos();
        const usedToday = JSON.parse(localStorage.getItem("usedVideos") || "{}");
        const currentDate = getCurrentDate();
        const list = getStoredVideos();
        list.forEach((link, index) => {
          const isUsed = usedToday[currentDate]?.includes(link.url) || false;
          const wrapper = document.createElement("div");
          wrapper.style = "display: flex; align-items: center; gap: 4px;";
          if (isDeleteMode) {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox"; checkbox.className = "deleteCheckbox"; checkbox.dataset.index = index; wrapper.appendChild(checkbox);
          }
          const btn = document.createElement("button");
          btn.textContent = isUsed ? `‚úÖ ${link.title}` : link.title;
          btn.disabled = isUsed;
          btn.onclick = () => { if (!isUsed && !isDeleteMode) { markVideoUsed(link.url); window.open(link.url, "_blank"); renderVideoLinks(); } };
          btn.style = `padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px; background-color: #2196F3; color: white; border: none; white-space: nowrap;`;
          wrapper.appendChild(btn);
          container.appendChild(wrapper);
        });
      }
      function confirmDeleteSelected() {
        const checkboxes = document.querySelectorAll(".deleteCheckbox:checked");
        if (checkboxes.length === 0) return alert("Ch∆∞a ch·ªçn video n√†o ƒë·ªÉ x√≥a.");
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√°c video ƒë√£ ch·ªçn kh√¥ng?")) return;
        const list = getStoredVideos();
        const remaining = list.filter((_, index) => { return !Array.from(checkboxes).some(cb => parseInt(cb.dataset.index) === index); });
        saveVideos(remaining); renderVideoLinks(); alert("ƒê√£ xo√° video ƒë√£ ch·ªçn!");
      }
      function addVideo() {
        const title = document.getElementById("newVideoTitle").value.trim();
        const url = document.getElementById("newVideoUrl").value.trim();
        if (!title || !url) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† link!");
        const list = getStoredVideos();
        if (list.some(v => v.url === url)) return alert("Video n√†y ƒë√£ t·ªìn t·∫°i!");
        list.push({ title, url }); saveVideos(list); renderVideoLinks();
        document.getElementById("newVideoTitle").value = ''; document.getElementById("newVideoUrl").value = ''; alert("ƒê√£ th√™m video!");
      }
      renderVideoLinks();
    </script>
  </div>
</body>
</html>
